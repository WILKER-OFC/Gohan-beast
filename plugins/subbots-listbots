import fs from 'fs'

let handler = async (m, { conn }) => {
  let uniqueUsers = new Map()

  if (!global.conns || !Array.isArray(global.conns)) global.conns = []

  for (const connSub of global.conns) {
    if (connSub.user && connSub.state === 'open') {
      const jid = connSub.user.jid
      const numero = jid?.split('@')[0]
      let nombre = connSub.user.name
      if (!nombre && typeof conn.getName === 'function') {
        try {
          nombre = await conn.getName(jid)
        } catch {
          nombre = `Usuario ${numero}`
        }
      }
      uniqueUsers.set(jid, {
        nombre: nombre || `Usuario ${numero}`,
        numero,
        fecha: connSub.user.registro || 'Desconocida'
      })
    }
  }

  const uptime = process.uptime() * 1000
  const formatUptime = clockString(uptime)
  const totalUsers = uniqueUsers.size

  // Estilo Gohan Beast
  let txt = `â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—\n`
  txt += `   âš¡ *GO-HAN BEAST BOT* âš¡\n`
  txt += `â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\n`
  txt += `ğŸŒ€ *Tiempo Activo:* ${formatUptime}\n`
  txt += `ğŸ‘¥ *Sub-Bots Conectados:* ${totalUsers}\n\n`

  let mentions = []

  if (totalUsers > 0) {
    txt += `â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—\n`
    txt += `       ğŸ“Š *LISTA ACTIVA*\n`
    txt += `â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\n`
    
    let i = 1
    for (const [jid, data] of uniqueUsers) {
      const powerLevel = Math.floor(Math.random() * 9000) + 1000 // Nivel de poder aleatorio estilo DB
      
      txt += `â–°â–°â–°â–°â–°â–°â–°â–°â–°â–°â–°â–°â–°â–°â–°â–°â–°â–°â–°â–°\n`
      txt += `âœ¨ *SUB-BOT #${i++}*\n`
      txt += `â¤ ğŸ†” *ID:* @${data.numero}\n`
      txt += `â¤ ğŸ‘¤ *Nombre:* ${data.nombre}\n`
      txt += `â¤ âš¡ *Poder:* ${powerLevel.toLocaleString()}\n`
      txt += `â¤ ğŸ“… *Registro:* ${data.fecha}\n`
      txt += `â–°â–°â–°â–°â–°â–°â–°â–°â–°â–°â–°â–°â–°â–°â–°â–°â–°â–°â–°â–°\n\n`
      mentions.push(jid)
    }
  } else {
    txt += `â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—\n`
    txt += `       âš ï¸ *SIN ACTIVIDAD*\n`
    txt += `â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\n`
    txt += `Actualmente no hay sub-bots conectados.\nÂ¡ConviÃ©rtete en el primero! ğŸ¥‹`
  }

  // Emojis de Dragon Ball
  const beastEmojis = ['âš¡', 'ğŸ”¥', 'ğŸŒ€', 'ğŸ’¥', 'ğŸŒŸ', 'ğŸ¥‹', 'ğŸ‰']
  const randomEmoji = beastEmojis[Math.floor(Math.random() * beastEmojis.length)]
  
  txt += `\n${randomEmoji} *Â¡GO-HAN BEAST LISTO PARA LA BATALLA!* ${randomEmoji}`

  await conn.reply(m.chat, txt.trim(), m, { 
    mentions,
    contextInfo: {
      externalAdReply: {
        title: 'âš¡ GO-HAN BEAST BOT âš¡',
        body: `Total: ${totalUsers} Sub-Bots`,
        thumbnailUrl: 'https://i.imgur.com/9E6q3Yv.jpeg',
        sourceUrl: 'https://whatsapp.com/channel/0029Va9A5p4J90Xe1RlEo13g',
        mediaType: 1,
        renderLargerThumbnail: true
      }
    }
  })
}

handler.command = ['listbots', 'bots', 'gohanlist', 'sublist']
handler.help = ['listbots']
handler.tags = ['serbot']

export default handler

function clockString(ms) {
  const d = Math.floor(ms / 86400000)
  const h = Math.floor(ms / 3600000) % 24
  const m = Math.floor(ms / 60000) % 60
  const s = Math.floor(ms / 1000) % 60
  return `${d}d ${h}h ${m}m ${s}s`
}